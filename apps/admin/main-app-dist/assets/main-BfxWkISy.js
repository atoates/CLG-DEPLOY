import"./config-B88kdatl.js";function dt(){const e=typeof window<"u"&&window.BACKEND_URL?window.BACKEND_URL:"";if(e)return e;try{const t=window.location.hostname||"";if(t&&t!=="localhost"&&t!=="127.0.0.1")return"https://app.crypto-lifeguard.com"}catch{}return""}function w(e){return`${dt()}${e}`}function k(e,t={}){return fetch(e,{credentials:"include",...t})}const Ye=["BTC","ETH","USDT","USDC","BNB","SOL","XRP","ADA","DOGE","TRX","TON","DOT","MATIC","AVAX","LINK","UNI","ATOM","ALGO","XMR","LTC","ETC","BCH","BSV","XLM","HBAR","APT","ARB","OP","SUI","NEAR","ICP","MKR","AAVE","COMP","SNX","CRV","BAL","YFI","ZEC","DASH","EOS","FIL","VET","XTZ","KSM","GLMR","POL","OMNI","UXLINK","ENA","DAI"],mt=[...Ye];document.getElementById("filter-tags-card");const W=document.getElementById("toggle-show-all"),Me=document.querySelectorAll(".sev-btn");let p=[],E=["critical","warning","info"],K=!1,te=new Set,C=!1,be=!1,M=[],F=[],_="$",Q="USD",_e="";const f=document.getElementById("token-input"),V=document.getElementById("toggle-show-all-tokens"),Ee=document.getElementById("alerts-list"),De=document.getElementById("no-alerts"),Pe=document.getElementById("panel-alerts"),Ce=document.getElementById("panel-summary"),Fe=document.getElementById("panel-news"),He=document.getElementById("panel-market"),re=document.getElementById("summary-stamp"),B=document.getElementById("summary-model"),le=document.querySelectorAll(".tab"),Oe=document.getElementById("sev-filter"),Re=document.getElementById("showall-wrap"),ie=document.getElementById("selected-tokens"),Ue=document.getElementById("add-token-btn"),qe=document.getElementById("market-grid"),je=document.getElementById("market-empty"),j=document.getElementById("market-note"),Ae={"price-change":{icon:"üìä",label:"Price Change",color:"#4ade80"},migration:{icon:"üîÑ",label:"Migration",color:"#60a5fa"},hack:{icon:"üîì",label:"Hack",color:"#f87171"},fork:{icon:"üî±",label:"Fork",color:"#a78bfa"},scam:{icon:"‚ö†Ô∏è",label:"Scam",color:"#fbbf24"},airdrop:{icon:"ü™Ç",label:"Airdrop",color:"#34d399"},whale:{icon:"üêã",label:"Whale Alert",color:"#818cf8"},news:{icon:"üì∞",label:"News",color:"#94a3b8"},community:{icon:"üë•",label:"Community",color:"#fb923c"},exploit:{icon:"‚ö°",label:"Exploit",color:"#f43f5e"},privacy:{icon:"üõ°Ô∏è",label:"Privacy",color:"#22c55e"},"community-vote":{icon:"üó≥Ô∏è",label:"Community Vote",color:"#8b5cf6"},"token-unlocks":{icon:"üîí",label:"Token Unlocks",color:"#f59e0b"}},ut={anonymous:{icon:"üôà",label:"Anonymous"},"mainstream-media":{icon:"üì∞",label:"Mainstream media"},"trusted-source":{icon:"‚úÖ",label:"Trusted source"},"social-media":{icon:"üí¨",label:"Social media"},"dev-team":{icon:"üõ†Ô∏è",label:"Dev. Team"}};let A=[],X=[],ze="none",Y=null,z=null,we=null;function Ge(e){if(!Number.isFinite(e))return"";const t=e<0,n=Math.abs(e),o=Math.round(n/1e3),s=Math.floor(o/86400),a=Math.floor(o%86400/3600),i=Math.floor(o%3600/60),r=[];return s&&r.push(`${s}d`),a&&r.push(`${a}h`),!s&&i&&r.push(`${i}m`),r.length||r.push("now"),t?`Expired ${r.join(" ")} ago`:`Due in ${r.join(" ")}`}function pt(e){if(typeof e!="number"||!Number.isFinite(e))return`${_}‚Äî`;try{return new Intl.NumberFormat(void 0,{style:"currency",currency:Q,maximumFractionDigits:2}).format(e)}catch{return`${_}${e.toFixed(2)}`}}function ce(e){if(e==null||!Number.isFinite(Number(e)))return"‚Äî";const t=Number(e);return`${t>0?"+":""}${t.toFixed(2)}%`}function Ke(e){if(typeof e!="number"||!Number.isFinite(e))return"‚Äî";const t=Math.abs(e);return t>=1e12?`${(e/1e12).toFixed(2)}T`:t>=1e9?`${(e/1e9).toFixed(2)}B`:t>=1e6?`${(e/1e6).toFixed(2)}M`:t>=1e3?`${(e/1e3).toFixed(2)}K`:`${e.toFixed(0)}`}function Ne(e){return e.id||`${(e.token||"").toUpperCase()}::${e.title||""}::${e.deadline||""}`}function Te(e){return te.has(Ne(e))}function gt(e){te.add(Ne(e)),P(),S()}function ft(e){te.delete(Ne(e)),P(),S()}function Je(){if(ie){if(ie.innerHTML="",!p.length){const e=document.createElement("span");e.className="muted",e.textContent="No tokens selected yet.",ie.appendChild(e);return}p.forEach(e=>{const t=document.createElement("span");t.className="pill",t.textContent=e;const n=document.createElement("button");n.type="button",n.className="pill-x",n.setAttribute("aria-label",`Remove ${e}`),n.textContent="√ó",n.addEventListener("click",()=>{p=p.filter(o=>o!==e),P(),Je(),S(),ge(),ct(),me()}),t.appendChild(n),ie.appendChild(t)})}}let Ve=!1;function Ze(){Me.forEach(e=>{const t=e.getAttribute("data-sev"),n=E.includes(t);e.classList.toggle("active",n),e.setAttribute("aria-pressed",String(n))}),Ve||(Ve=!0,Me.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sev");t&&(E.includes(t)?E=E.filter(n=>n!==t):E=[...new Set([...E,t])],E.length||(E=["critical","warning","info"]),Ze(),P(),S(),ne())})}))}Ue&&Ue.addEventListener("click",()=>{const e=(f?.value||"").trim();e&&J(e)});W&&W.addEventListener("change",()=>{K=!!W.checked,P(),S(),ne()});function ht(e){const t=String(e||"alerts");Pe&&(Pe.hidden=t!=="alerts"),Ce&&(Ce.hidden=t!=="summary"),Fe&&(Fe.hidden=t!=="news"),He&&(He.hidden=t!=="market"),le.forEach(n=>{const o=n.getAttribute("data-tab")===t;n.classList.toggle("active",o),n.setAttribute("aria-selected",String(o))}),Qe(t),t==="summary"&&$e(),t==="news"&&ct(),t==="market"&&ge()}function yt(){!le||!le.length||le.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-tab");ht(n)})})}function Qe(e){const t=e==="alerts";Oe&&(Oe.style.display=t?"":"none"),Re&&(Re.style.display=t?"":"none")}function P(){clearTimeout(P._t),P._t=setTimeout(()=>{k(w("/api/me/prefs"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({watchlist:p,severity:E,showAll:K,dismissed:[...te]})}).catch(()=>{})},250)}async function wt(){try{const e=await k(w("/api/environment"));if(e.ok){const t=await e.json();t.environment&&t.environment!=="production"&&vt(t.environment)}}catch{console.log("Could not fetch environment info")}}function vt(e){const t=document.getElementById("env-banner");if(t){t.hidden=!1,document.body.classList.add("has-env-banner");const n=t.querySelector(".env-text");n&&(e==="staging"||e==="test"?n.textContent="üß™ TEST ENVIRONMENT":e==="development"?n.textContent="üíª DEVELOPMENT":n.textContent=`‚ö†Ô∏è ${e.toUpperCase()}`)}}let ve=null;async function kt(){try{const e=["BTC","ETH","SOL","BNB","XRP"];let t;if(p.length>=5)t=p;else if(p.length>0){const a=5-p.length,i=e.filter(r=>!p.includes(r)).slice(0,a);t=[...p,...i]}else t=e;if(t.length===0)return console.log("No tokens selected for ticker"),[];const n=t.join(","),o=await k(w(`/api/market/prices?symbols=${n}&currency=${Q}`));if(!o.ok)return console.error("Failed to fetch ticker prices:",o.status),[];const s=await o.json();return console.log("Fetched ticker data:",s),s.prices||[]}catch(e){return console.error("Error fetching ticker prices:",e),[]}}function bt(e){return e>=1e3?`${_}${e.toLocaleString(void 0,{maximumFractionDigits:0})}`:e>=1?`${_}${e.toLocaleString(void 0,{maximumFractionDigits:2})}`:e>=.01?`${_}${e.toLocaleString(void 0,{maximumFractionDigits:4})}`:`${_}${e.toLocaleString(void 0,{maximumFractionDigits:6})}`}function Et(e){const t=document.getElementById("price-ticker"),n=t?.querySelector(".ticker-content"),o=t?.querySelector(".ticker-duplicate");if(!t||!n||!o){console.log("Ticker elements not found");return}if(!e||e.length===0){console.log("No price data to display in ticker"),t.hidden=!0;return}const s=e.map(a=>{const i=a.change24h>0?"positive":a.change24h<0?"negative":"neutral",c=`${a.change24h>0?"‚ñ≤":a.change24h<0?"‚ñº":"‚Ä¢"} ${Math.abs(a.change24h).toFixed(2)}%`;return`
      <div class="ticker-item">
        <span class="ticker-symbol">${a.symbol}</span>
        <span class="ticker-price">${bt(a.price)}</span>
        <span class="ticker-change ${i}">${c}</span>
      </div>
    `}).join("");n.innerHTML=s,o.innerHTML=s,t.hidden=!1,console.log(`Ticker rendered with ${e.length} tokens`)}async function me(){console.log("Updating price ticker...");const e=await kt();Et(e)}function Ct(){console.log("Starting price ticker..."),me(),ve&&clearInterval(ve),ve=setInterval(me,3e5)}document.addEventListener("DOMContentLoaded",()=>{wt();const e=document.getElementById("user-menu-btn"),t=document.getElementById("user-menu");document.getElementById("menu-logout"),e&&t&&(e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const o=t.hidden;t.hidden=!o,e.setAttribute("aria-expanded",!o)}),document.addEventListener("click",n=>{!t.contains(n.target)&&!e.contains(n.target)&&(t.hidden=!0,e.setAttribute("aria-expanded","false"))}),t.addEventListener("click",n=>{const o=n.target.closest(".menu-item");if(!o)return;const s=o.getAttribute("data-action");s&&(t.hidden=!0,e.setAttribute("aria-expanded","false"),s==="login"&&(window.location.href="/signup"),(s==="settings"||s==="profile")&&(window.location.href="/profile"),s==="help"&&window.open("https://github.com/atoates/CLG-DEPLOY","_blank"),s==="logout"&&k(w("/auth/logout"),{method:"POST"}).finally(()=>{window.location.reload()}))})),Y=document.getElementById("summary-prev"),z=document.getElementById("summary-next"),we=document.getElementById("summary-refresh"),Y&&Y.addEventListener("click",async()=>{I.length||(I=await Z(10),b=0);const n=Math.min(b+1,I.length-1);if(n!==b){b=n;const o=I[b];xe(o),de(o),H(I,b)}}),z&&z.addEventListener("click",async()=>{I.length||(I=await Z(10),b=0);const n=Math.max(b-1,0);if(n!==b){b=n;const o=I[b];xe(o),de(o),H(I,b)}}),we&&we.addEventListener("click",async()=>{I=[],b=-1,await qt(),setTimeout(async()=>{const n=await Z(10);n.length&&(H(n,0),de(n[0]))},1e3)})});(async function(){let t={};try{const n=await k(w("/api/market/config"));if(n.ok){const o=await n.json();o&&o.symbol&&(_=String(o.symbol)),o&&o.currency&&(Q=String(o.currency)),o&&o.logokitApiKey&&(_e=String(o.logokitApiKey),window.logokitApiKey=_e),o&&o.currencySymbols&&(t=o.currencySymbols)}}catch{}try{const n=await k(w("/api/me"));if(n.ok){const o=await n.json();p=Array.isArray(o.watchlist)?o.watchlist:[],E=Array.isArray(o.severity)?o.severity:["critical","warning","info"],K=!!o.showAll,te=new Set(Array.isArray(o.dismissed)?o.dismissed:[]),be=!!o.loggedIn,o.currency&&t[o.currency]&&(Q=o.currency,_=t[o.currency]);try{const s=document.getElementById("menu-logout");s&&(s.hidden=!o.loggedIn)}catch{}if(o.loggedIn){const s=document.getElementById("user-menu-btn"),a=document.getElementById("user-menu");if(a&&(a.hidden=!0),s){const i=s.cloneNode(!1);i.id="user-menu-btn",i.setAttribute("aria-haspopup","false"),i.setAttribute("aria-expanded","false");const r=document.createElement("span");r.style.display="inline-flex",r.style.alignItems="center",r.style.gap="8px";const c=document.createElement("span");c.style.width="22px",c.style.height="22px",c.style.borderRadius="999px",c.style.display="inline-block",c.style.overflow="hidden",c.style.background="#e2e8f0";const m=o.profile?.avatar||"";if(m){const u=document.createElement("img");u.src=m,u.alt="",u.width=22,u.height=22,u.style.display="block",c.appendChild(u)}else c.textContent=(o.profile?.name||"U").trim().charAt(0).toUpperCase(),c.style.fontWeight="800",c.style.color="#0f172a",c.style.display="grid";const g=document.createElement("span");g.textContent=o.profile?.username?`@${o.profile.username}`:o.profile?.name||"Profile",r.appendChild(c),r.appendChild(g),i.appendChild(r),s.parentNode.replaceChild(i,s),i.addEventListener("click",u=>{u.preventDefault(),window.location.href="/profile"})}}}}catch(n){console.warn("prefs load failed",n)}W&&(W.checked=K);try{C=localStorage.getItem("showAllTokens")==="1"}catch{}if(p.length===0&&localStorage.getItem("showAllTokens")===null){C=!0;try{localStorage.setItem("showAllTokens","1")}catch{}}if(V&&(V.checked=!!C),Ze(),B)try{const n=localStorage.getItem("clg_summary_model");n==="auto"?(B.value="openai",localStorage.setItem("clg_summary_model","openai")):n&&(B.value=n)}catch{}Ie(),await Bt(),await $t(),await At(),Lt(),yt(),ge(),Qe("alerts"),Ct(),V&&V.addEventListener("change",()=>{C=!!V.checked;try{localStorage.setItem("showAllTokens",C?"1":"0")}catch{}Ie()})})();let D=[],h=null,y=-1;async function At(){try{const e=await k(w("/api/tokens"));if(e.ok){const t=await e.json();D=t.tokens||[],console.log(`Loaded ${D.length} tokens from ${t.provider||"unknown"}`)}}catch(e){console.error("Failed to fetch token metadata:",e),D=mt.map(t=>({symbol:t,name:t}))}}function Tt(){h||(h=document.createElement("div"),h.className="token-autocomplete",h.style.display="none",f&&f.parentNode&&(f.parentNode.style.position="relative",f.parentNode.appendChild(h)))}function xt(e){if(!e||e.length<1)return[];const t=e.toLowerCase().trim();return D.filter(n=>{const o=n.symbol.toLowerCase().includes(t),s=n.name.toLowerCase().includes(t);return o||s}).slice(0,50).sort((n,o)=>{const s=n.symbol.toLowerCase().startsWith(t),a=o.symbol.toLowerCase().startsWith(t);if(s&&!a)return-1;if(!s&&a)return 1;const i=n.name.toLowerCase().startsWith(t),r=o.name.toLowerCase().startsWith(t);return i&&!r?-1:!i&&r?1:n.symbol.localeCompare(o.symbol)})}function It(e,t){if(!t)return e;const n=e.toLowerCase().indexOf(t.toLowerCase());if(n===-1)return e;const o=e.slice(0,n),s=e.slice(n,n+t.length),a=e.slice(n+t.length);return`${o}<strong>${s}</strong>${a}`}function We(e,t){if(h){if(!e.length&&!t.trim()){h.style.display="none";return}if(h.innerHTML="",y=-1,e.forEach((n,o)=>{const s=document.createElement("div");s.className="autocomplete-item",s.dataset.index=o,s.dataset.symbol=n.symbol;const a=`${n.name} | ${n.symbol}`;s.innerHTML=It(a,t),s.addEventListener("click",()=>{J(n.symbol)}),s.addEventListener("mouseenter",()=>{y=o,ue()}),h.appendChild(s)}),t.trim().length>=2){const n=document.createElement("div");n.className="autocomplete-item autocomplete-request",n.dataset.index=e.length,n.dataset.action="request",n.innerHTML=`
      <span class="request-icon">‚ûï</span>
      <span class="request-text">Request "${t.toUpperCase()}" to be added</span>
    `,n.addEventListener("click",()=>{Nt(t)}),n.addEventListener("mouseenter",()=>{y=e.length,ue()}),h.appendChild(n)}h.style.display="block"}}function G(){h&&(h.style.display="none",y=-1)}function ue(){if(!h)return;h.querySelectorAll(".autocomplete-item").forEach((t,n)=>{n===y?t.classList.add("selected"):t.classList.remove("selected")})}function J(e){const t=e.toUpperCase().trim();if(!t||p.includes(t)){G(),f.value="";return}p.push(t),P(),Ie(),ge(),tt().then(S),me(),f.value="",G(),f.focus()}function Nt(e){const t=document.getElementById("token-request-modal");if(!t)return;G(),f.value="";const n=document.getElementById("request-symbol"),o=document.getElementById("request-name"),s=document.getElementById("request-reason"),a=document.getElementById("request-website");n&&(n.value=e.toUpperCase().trim()),o&&(o.value=""),s&&(s.value=""),a&&(a.value=""),t.style.display="flex",o&&o.focus()}function et(){const e=document.getElementById("token-request-modal");e&&(e.style.display="none")}async function St(e){e.preventDefault();const t=document.getElementById("request-symbol").value.toUpperCase().trim(),n=document.getElementById("request-name").value.trim(),o=document.getElementById("request-reason").value.trim(),s=document.getElementById("request-website").value.trim();if(!t||!n||!o){alert("Please fill out all required fields (Symbol, Name, and Reason).");return}const a=e.target.querySelector('button[type="submit"]'),i=a.textContent;a.disabled=!0,a.textContent="Submitting...";try{const r=await k(w("/api/token-requests"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:t,name:n,reason:o,website:s})}),c=await r.json();if(r.ok)alert(`‚úÖ Token request submitted successfully!

Thank you for requesting ${t}. We'll review it soon.`),et();else if(r.status===429)alert(`‚ö†Ô∏è ${c.error||"This token has already been requested."}`);else if(r.status===400)alert(`‚ùå ${c.error||"Invalid request. Please check your inputs."}`);else throw new Error(c.error||"Failed to submit request")}catch(r){console.error("Token request error:",r),alert(`‚ùå Failed to submit token request: ${r.message}`)}finally{a.disabled=!1,a.textContent=i}}function Lt(){f&&(Tt(),f.removeAttribute("list"),f.addEventListener("input",e=>{const t=e.target.value.trim();if(t.length<1){G();return}const n=xt(t);We(n,t)}),f.addEventListener("keydown",e=>{if(!h||h.style.display==="none"){if(e.key==="Enter"){const n=f.value.toUpperCase().trim();n&&J(n)}return}const t=h.querySelectorAll(".autocomplete-item");if(e.key==="ArrowDown")e.preventDefault(),y=Math.min(y+1,t.length-1),ue(),t[y]&&t[y].scrollIntoView({block:"nearest"});else if(e.key==="ArrowUp")e.preventDefault(),y=Math.max(y-1,-1),ue(),y>=0&&t[y]&&t[y].scrollIntoView({block:"nearest"});else if(e.key==="Enter"){if(e.preventDefault(),y>=0&&t[y]){const n=t[y].dataset.symbol;J(n)}else if(t.length>0){const n=t[0].dataset.symbol;J(n)}}else e.key==="Escape"&&(G(),f.blur())}),f.addEventListener("blur",()=>{setTimeout(()=>G(),200)}),f.addEventListener("focus",()=>{if(f.value.trim().length===0){const e=D.slice(0,50);We(e,"")}}))}async function $t(){try{const e=await k(w("/api/alerts"));if(e.ok){const t=await e.json(),n=new Set(Ye.map(s=>String(s).toUpperCase()));t.forEach(s=>{const a=String(s.token||"").toUpperCase().trim();a&&/^[A-Z0-9]{2,15}$/.test(a)&&n.add(a)});const o=Array.from(n).sort().map(s=>({symbol:s,name:s}));(!Array.isArray(D)||D.length<o.length)&&(D=o)}}catch{}}async function Bt(){try{M=await(await k(w("/api/alerts"))).json(),console.log("DEBUG: Loaded",M.length,"alerts from server"),console.log("DEBUG: First few alerts:",M.slice(0,3))}catch(e){console.error("Failed to fetch /api/alerts",e),M=[]}await tt(),_t(),S(),Ut()}async function tt(){if(F=[],p.length===0)return;const e=p.join(","),t=[k(w(`/api/market/auto-alerts?symbols=${encodeURIComponent(e)}`)).then(n=>n.ok?n.json():[]).catch(()=>[])];try{const[n]=await Promise.all(t);F=Array.isArray(n)?n:[]}catch{F=[]}}function Mt(e){return!E||E.length===0?[]:e.filter(t=>E.includes(t.severity||"info"))}function _t(){const e=document.getElementById("tag-dropdown-trigger"),t=document.getElementById("tag-dropdown-options"),o=document.getElementById("reset-tags")||document.querySelector(".btn-clear-tags-popup"),s=new Set;[...M,...F].forEach(r=>{ee(r).forEach(m=>s.add(m))}),Object.keys(Ae).forEach(r=>s.add(r));const i=document.getElementById("popup-tag-filters");i.innerHTML="",Array.from(s).sort().forEach(r=>{const c=document.createElement("button");c.className="tag-filter",c.dataset.tag=r;const m=Ae[r],g=m?m.icon:"üè∑Ô∏è",u=m?m.label:r;c.innerHTML=`<span class="icon">${g}</span><span>${u}</span>`,c.addEventListener("click",function(l){l.preventDefault(),l.stopPropagation(),Pt(r)}),i.appendChild(c)}),t.dataset.bound||(e.addEventListener("click",function(r){r.stopPropagation(),Dt()}),t.addEventListener("click",function(r){r.stopPropagation()}),document.addEventListener("click",function(r){r.target.closest(".custom-dropdown")||nt()}),t.dataset.bound="1"),o&&o.addEventListener("click",Ft),Se(),Le()}function Dt(){const e=document.getElementById("tag-dropdown-trigger"),t=document.getElementById("tag-dropdown-options");t.classList.contains("open")?nt():(t.classList.add("open"),e.classList.add("active"))}function nt(){const e=document.getElementById("tag-dropdown-trigger");document.getElementById("tag-dropdown-options").classList.remove("open"),e.classList.remove("active")}function Pt(e){A.includes(e)?A=A.filter(t=>t!==e):A.push(e),Se(),Le(),S(),ne()}function Se(){document.querySelectorAll("#popup-tag-filters .tag-filter").forEach(t=>{const n=t.dataset.tag;t.classList.toggle("active",A.includes(n))})}function Le(){const e=document.querySelector(".dropdown-text");e&&(A.length===0?e.textContent="Select tags...":A.length===1?e.textContent=A[0]:e.textContent=`${A.length} tags selected`)}function Ft(){A=[],Se(),Le(),S(),ne()}function Ht(e){return A.length?e.filter(t=>{const n=ee(t);return n.length?A.some(o=>n.includes(o)):!1}):e}function ot(){const e=[...M,...F],t=C?e:e.filter(o=>p.includes((o.token||"").toUpperCase()));let n=Mt(t);return n=Ht(n),K||(n=n.filter(o=>!Te(o))),n}function ee(e){try{if(Array.isArray(e.tags))return e.tags;if(typeof e.tags=="string"&&e.tags.trim()){const n=JSON.parse(e.tags);if(Array.isArray(n))return n}}catch{}const t=e.severity||"info";return t==="critical"?["hack","exploit"]:t==="warning"?["community","migration"]:["community","news"]}function Ot(e,t){ee(e).forEach(o=>{const s=Ae[o];if(!s)return;const a=document.createElement("span");a.className="alert-tag",a.style.backgroundColor=s.color+"15",a.style.borderColor=s.color+"40",a.style.color=s.color;const i=document.createElement("span");i.className="tag-icon",i.textContent=s.icon;const r=document.createElement("span");r.textContent=s.label,a.appendChild(i),a.appendChild(r),t.appendChild(a)})}function Rt(e){const t=Date.now(),n=a=>new Date(a.deadline).getTime(),o=e.filter(a=>n(a)>=t).sort((a,i)=>n(a)-n(i)),s=e.filter(a=>n(a)<t).sort((a,i)=>n(a)-n(i));return o.concat(s)}function S(){const e=Rt(ot());if(Ee.innerHTML="",e.length===0){De.hidden=!1;return}else De.hidden=!0;e.forEach(t=>{const n=document.createElement("div");n.className="alert-item severity-"+(t.severity||"info");const o=Te(t);K&&o&&n.classList.add("is-hidden");const s=document.createElement("button");s.type="button",s.className="alert-dismiss-btn",s.setAttribute("aria-label",o?"Unhide alert":"Dismiss alert"),s.title=o?"Unhide alert":"Dismiss alert",s.textContent="√ó",s.addEventListener("click",()=>{Te(t)?ft(t):gt(t)}),n.appendChild(s);const a=document.createElement("div");a.className="alert-accent",ee(t).includes("migration")&&a.classList.add("accent-migration"),n.appendChild(a);const r=document.createElement("div");r.className="coin-section";const c=document.createElement("div");c.className="coin-logo";const m=(t.token||"").toUpperCase(),g=w(`/api/logo/${m}`),u=document.createElement("img");u.className="coin-img",u.src=g,u.alt=`${m} logo`,u.onerror=function(){this.onerror=null,this.src=w(`/api/logo/${m}`)},c.appendChild(u);const l=document.createElement("div");l.className="coin-symbol",l.textContent=m,r.appendChild(c),r.appendChild(l);const d=document.createElement("div");d.className="severity-badge";const L=document.createElement("img");L.alt=`${t.severity||"info"} icon`,L.className="severity-icon-img",L.decoding="async",L.fetchPriority="low";const oe=t.severity||"info",O="20251021c";L.src=oe==="critical"?`/icons/siren@64px.svg?v=${O}`:oe==="warning"?`/icons/flag@64px.svg?v=${O}`:`/icons/lifebuoy@64px.svg?v=${O}`,L.onerror=function(){this.style.display="none"},d.appendChild(L);const R=document.createElement("div");R.className="alert-content-area";const $=document.createElement("div");$.className="alert-text";const fe=document.createElement("div");fe.className="alert-title",fe.textContent=t.title,$.appendChild(fe);const he=document.createElement("div");he.className="alert-desc",he.textContent=t.description||"",$.appendChild(he);const se=document.createElement("div");se.className="alert-meta";const ae=document.createElement("span");ae.className="deadline-chip";const lt=new Date(t.deadline).getTime()-Date.now();ae.textContent=Ge(lt),se.appendChild(ae);try{if(ee(t).includes("migration")){const T=document.createElement("span");T.className="alert-pill-migration";const v=document.createElement("span");v.className="icon";const N=document.createElement("img");N.src=`/icons/lifebuoy@64px.svg?v=${O}`,N.alt="",N.className="icon-img",N.onerror=function(){this.style.display="none"},v.appendChild(N);const U=document.createElement("span");U.textContent="Token Migration",T.appendChild(v),T.appendChild(U),se.appendChild(T)}}catch{}if($.appendChild(se),!!(t.further_info&&t.further_info.trim())||!!(t.source_type||t.source_url)){const x=document.createElement("button");x.type="button",x.className="more-toggle",x.setAttribute("aria-expanded","false"),x.textContent="Read more";const T=document.createElement("div");if(T.className="more-content",T.hidden=!0,t.further_info&&t.further_info.trim()){const v=document.createElement("div");v.className="more-info",v.textContent=t.further_info,T.appendChild(v)}if(t.source_type||t.source_url){const v=document.createElement("div");v.className="source-row";const N=ut[t.source_type]||null,U=document.createElement("span");if(U.className="source-chip",U.textContent=`${N?N.icon:"üîó"} ${N?N.label:"Source"}`,v.appendChild(U),t.source_url)try{const Be=new URL(t.source_url),q=document.createElement("a");q.className="source-link",q.href=Be.href,q.target="_blank",q.rel="noopener noreferrer",q.textContent="Open link",v.appendChild(q)}catch{}T.appendChild(v)}x.addEventListener("click",()=>{const v=T.hidden;T.hidden=!v,x.setAttribute("aria-expanded",String(v)),x.textContent=v?"Read less":"Read more"}),$.appendChild(x),$.appendChild(T)}R.appendChild(d),R.appendChild($);const ye=document.createElement("div");ye.className="alert-tags-section",Ot(t,ye),n.appendChild(r),n.appendChild(R),n.appendChild(ye),n._tick=()=>{const x=new Date(t.deadline).getTime()-Date.now();ae.textContent=Ge(x)},Ee.appendChild(n)})}let ke=null;function Ut(){ke&&clearInterval(ke),ke=setInterval(()=>{[...Ee.children].forEach(e=>{typeof e._tick=="function"&&e._tick()})},1e3)}async function qt(){const e=document.getElementById("summary-content");e.innerHTML=`
    <div class="loading-state">
      <div class="countdown-container">
        <div class="countdown-circle">
          <svg class="countdown-svg" viewBox="0 0 100 100">
            <circle class="countdown-track" cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8"/>
            <circle class="countdown-progress" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="8" 
                    stroke-linecap="round" transform="rotate(-90 50 50)"/>
          </svg>
          <div class="countdown-number">30</div>
        </div>
        <p class="countdown-text">ü§ñ Generating AI summary...</p>
      </div>
    </div>
  `;let t=30;const n=e.querySelector(".countdown-number"),o=e.querySelector(".countdown-progress"),s=2*Math.PI*45;if(o.style.strokeDasharray=s,o.style.strokeDashoffset=0,window.currentCountdownInterval=setInterval(()=>{t--,n.textContent=t;const a=(30-t)/30,i=s*(1-a);o.style.strokeDashoffset=i,t<=0&&(clearInterval(window.currentCountdownInterval),n.textContent="‚è≥",e.querySelector(".countdown-text").textContent="ü§ñ Finalizing summary...")},1e3),!p.length&&!C){e.innerHTML='<p class="muted">Select some tokens to see an AI-generated summary of your alerts.</p>';return}try{const a=st();if(a.length===0){e.innerHTML='<p class="muted">No alerts match your current filters. Adjust your severity or tag filters to see a summary.</p>';return}const i=await k(w("/api/summary/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({alerts:a,tokens:C?pe(a):p,sevFilter:E,tagFilter:A,model:jt()})});if(!i.ok){if(i.status===401){window.currentCountdownInterval&&clearInterval(window.currentCountdownInterval),e.innerHTML=`
          <div style="text-align: center; padding: 40px 20px;">
            <h2 style="margin-bottom: 16px;">ü§ñ AI-Powered Alert Summaries</h2>
            <p style="color: #64748b; margin-bottom: 24px;">
              Get intelligent analysis of your crypto alerts with AI-generated summaries.
            </p>
            <div style="background: #f1f5f9; border-radius: 8px; padding: 20px; margin-bottom: 24px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
              <p style="margin: 0 0 12px 0;"><strong>‚ú® Features include:</strong></p>
              <ul style="margin: 0; padding-left: 20px; color: #475569;">
                <li>Multi-model AI analysis (OpenAI, Anthropic, xAI)</li>
                <li>Severity-based prioritization</li>
                <li>Historical summary tracking</li>
                <li>Customizable filters and preferences</li>
              </ul>
            </div>
            <a href="/auth/google" class="btn-primary" style="display: inline-block; padding: 12px 32px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
              Sign in with Google to Continue
            </a>
          </div>
        `;return}throw new Error(`HTTP ${i.status}`)}const r=await i.json();window.currentCountdownInterval&&clearInterval(window.currentCountdownInterval),e.innerHTML="";const c=document.createElement("div");c.className="summary-header";let m="";r.usage&&(r.usage.total_tokens?m=` ‚Ä¢ ${r.usage.total_tokens} API tokens`:r.usage.input_tokens&&r.usage.output_tokens&&(m=` ‚Ä¢ ${r.usage.input_tokens+r.usage.output_tokens} API tokens`));const g=new Date(r.timestamp).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",year:"numeric",month:"short",day:"2-digit",timeZoneName:"short"});c.innerHTML=`
      <h2 class="section-title">ü§ñ AI Portfolio Summary</h2>
      <div class="summary-meta">
        <span>${r.alertCount} alerts ‚Ä¢ ${r.tokenCount} crypto tokens${m}</span>
        <span class="model-info">Generated by ${r.model} ‚Ä¢ ${g}</span>
      </div>
    `,e.appendChild(c);const u=document.createElement("div");u.className="summary-text";const l=at(r.summary);u.innerHTML=l,e.appendChild(u),r.news&&r.news.length>0?rt(r.news):it();try{const d=await Z(10);H(d,0)}catch(d){console.warn("Failed to refresh summary history:",d)}}catch(a){console.error("Failed to generate AI summary:",a),window.currentCountdownInterval&&clearInterval(window.currentCountdownInterval),e.innerHTML="";const i=document.createElement("h2");i.className="section-title",i.textContent="üìä Basic Summary",e.appendChild(i);const r=Gt(),c=document.createElement("div");c.innerHTML=r,e.appendChild(c);const m=document.createElement("p");m.className="muted",m.textContent="AI summary unavailable. Check API configuration.",e.appendChild(m)}}async function $e(){const e=document.getElementById("summary-content");if(!be){e.innerHTML=`
      <div style="text-align: center; padding: 40px 20px;">
        <h2 style="margin-bottom: 16px;">ü§ñ AI-Powered Alert Summaries</h2>
        <p style="color: #64748b; margin-bottom: 24px;">
          Get intelligent analysis of your crypto alerts with AI-generated summaries.
        </p>
        <div style="background: #f1f5f9; border-radius: 8px; padding: 20px; margin-bottom: 24px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
          <p style="margin: 0 0 12px 0;"><strong>‚ú® Features include:</strong></p>
          <ul style="margin: 0; padding-left: 20px; color: #475569;">
            <li>Multi-model AI analysis (OpenAI, Anthropic, xAI)</li>
            <li>Severity-based prioritization</li>
            <li>Historical summary tracking</li>
            <li>Customizable filters and preferences</li>
          </ul>
        </div>
        <a href="/auth/google" class="btn-primary" style="display: inline-block; padding: 12px 32px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
          Sign in with Google to Continue
        </a>
      </div>
    `,H([],-1);return}try{const t=await Z(10);if(t&&t.length>0){const n=t[0];xe(n),H(t,0),de(n);return}}catch{}if(be){e.innerHTML='<p class="muted">No saved summaries yet. Click <strong>Refresh</strong> to generate your first summary.</p>',H([],-1);return}}let I=[],b=-1;function de(e){if(re)try{const t=e.created_at||e.timestamp;if(t){const n=new Date(t).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",year:"numeric",month:"short",day:"2-digit",timeZoneName:"short"});re.textContent=`Generated ${n}`}else re.textContent=""}catch{re.textContent=""}}function xe(e){const t=document.getElementById("summary-content");t.innerHTML="";const n=document.createElement("div");n.className="summary-header";const o=Array.isArray(e.tokens)?e.tokens:[],s=e.usage||null;let a="";if(s){const r=s.total_tokens||(s.input_tokens||0)+(s.output_tokens||0);r&&(a=` ‚Ä¢ ${r} API tokens`)}n.innerHTML=`
    <h2 class="section-title">ü§ñ AI Portfolio Summary</h2>
    <div class="summary-meta">
      <span>${(e.alertIds||[]).length||""} ${(e.alertIds||[]).length===1?"alert":"alerts"}${o.length?` ‚Ä¢ ${o.length} tokens`:""}${a}</span>
      <span class="model-info">Generated by ${e.model||"AI"}${e.created_at?` ‚Ä¢ ${new Date(e.created_at).toLocaleTimeString()}`:""}</span>
    </div>
  `,t.appendChild(n);const i=document.createElement("div");i.className="summary-text",i.innerHTML=at(e.content||""),t.appendChild(i)}function H(e,t){I=e.slice(),b=t,Y&&(Y.disabled=t>=e.length-1),z&&(z.disabled=t<=0)}async function Z(e=10){try{const t=await k(w(`/api/summary/recent?limit=${e}`));if(!t.ok)return[];const n=await t.json();return Array.isArray(n.summaries)?n.summaries:[]}catch{return[]}}function st(){return ot()}function ne(){Ce.hidden||$e()}function jt(){try{return B&&B.value?B.value:localStorage.getItem("clg_summary_model")||"openai"}catch{return"openai"}}B&&B.addEventListener("change",()=>{try{localStorage.setItem("clg_summary_model",B.value)}catch{}ne()});function pe(e){return[...new Set(e.map(t=>t.token))].sort()}function at(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>").replace(/^(\d+\..*$)/gm,"<li>$1</li>").replace(/^(-.*$)/gm,'<li style="list-style: none;">$1</li>')}function Gt(){const e=st(),t=e.filter(a=>a.severity==="critical").length,n=e.filter(a=>a.severity==="warning").length,o=e.filter(a=>a.severity==="info").length,s=C?pe(e):p;return`
    <p><strong>Alert Overview:</strong> ${e.length} total alerts across ${s.length} tokens</p>
    <p><strong>Severity Breakdown:</strong> ${t} critical, ${n} warning, ${o} info</p>
    <p><strong>Monitored Tokens:</strong> ${s.join(", ")}</p>
    <p><em>Enable AI analysis by configuring OpenAI or Anthropic API keys for detailed insights.</em></p>
  `}function rt(e){const t=document.getElementById("news-content");if(!t)return;if(t.innerHTML="",!e||e.length===0){t.innerHTML='<div class="news-placeholder">No recent news available for your selected tokens.</div>';return}const n=document.createElement("div");n.className="news-header-row";const o=document.createElement("h3");o.className="news-header",o.textContent="üì∞ Your tokens in the News",n.appendChild(o);const a=(C?pe([...M,...F]):p).filter(g=>e.some(u=>u.tickers&&u.tickers.includes(g)||u.token===g)).sort(),i=document.createElement("div");i.className="news-filter-container";const r=document.createElement("select");r.className="news-token-filter",r.innerHTML=`
    <option value="all">All tokens</option>
    ${a.map(g=>`<option value="${g}">${g}</option>`).join("")}
  `,i.appendChild(r),n.appendChild(i),t.appendChild(n);const c=document.createElement("div");c.className="news-container";const m=(g="all")=>{c.innerHTML="",(g==="all"?e:e.filter(l=>l.tickers&&l.tickers.length>0?l.tickers.includes(g):l.token===g)).forEach(l=>{const d=document.createElement("div");d.className="news-item";const L=new Date(l.date||l.publishedAt).toLocaleDateString(),oe=l.tickers&&l.tickers.length>0?l.tickers.slice(0,3).map($=>`<span class="news-ticker">${$}</span>`).join(""):l.token?`<span class="news-ticker">${l.token}</span>`:"",O=l.sentiment==="positive"?"sentiment-positive":l.sentiment==="negative"?"sentiment-negative":"sentiment-neutral",R=l.sentiment==="positive"?"üìà":l.sentiment==="negative"?"üìâ":"üìä";d.innerHTML=`
        <div class="news-content">
          <h4 class="news-title">
            ${l.news_url&&l.news_url!=="#"?`<a href="${l.news_url}" target="_blank" rel="noopener">${l.title}</a>`:l.title}
          </h4>
          <p class="news-description">${l.text||l.description||"No description available"}</p>
          <div class="news-meta">
            <span class="news-source">${l.source_name||l.source&&l.source.name||"Unknown"}</span>
            <span class="news-date">${L}</span>
            ${l.sentiment&&l.sentiment!=="neutral"?`<span class="news-sentiment ${O}">${R} ${l.sentiment}</span>`:""}
            ${oe}
          </div>
        </div>
      `,c.appendChild(d)})};m(),r.addEventListener("change",g=>{m(g.target.value)}),t.appendChild(c)}function it(){const e=document.getElementById("news-content");e&&(e.innerHTML='<div class="news-placeholder">Select some tokens in your watchlist to see recent news.</div>')}async function ct(){console.log("[News Debug] loadNews() called");const e=document.getElementById("news-content");if(!e){console.error("[News Debug] newsContent element not found!");return}if(console.log("[News Debug] selectedTokens:",p),console.log("[News Debug] showAllTokens:",C),!p.length&&!C){console.log("[News Debug] No tokens selected, clearing news tab"),it();return}e.innerHTML='<div class="news-placeholder">üì∞ Loading recent news...</div>';try{const t=C?pe([...M,...F]):p;console.log("[News Debug] Fetching news for tokens:",t);const n=await k(w("/api/news"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tokens:t})});if(console.log("[News Debug] Response status:",n.status),!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();console.log("[News Debug] Received data:",o),console.log("[News Debug] News count:",o.news?o.news.length:0),o.news&&o.news.length>0?(console.log("[News Debug] Calling updateNewsTab with",o.news.length,"articles"),rt(o.news)):(console.log("[News Debug] No news data, showing placeholder"),e.innerHTML='<div class="news-placeholder">No recent news available for your selected tokens.</div>')}catch(t){console.error("[News Debug] Error loading news:",t),e.innerHTML='<div class="news-placeholder">Failed to load news. Please try again later.</div>'}}async function ge(){if(!p.length){X=[],j&&(j.textContent="Add tokens to your watchlist to see market data."),Xe();return}const e=p.join(",");try{const n=await(await k(w(`/api/market/snapshot?symbols=${encodeURIComponent(e)}&currency=${Q}`))).json();X=n.items||[],ze=n.provider||"none",j&&(j.textContent=n.note||"Market data unavailable.")}catch(t){console.error("snapshot error",t),X=[],j&&(j.textContent="Data unavailable (free plan limits).")}Xe()}function Xe(){if(qe.innerHTML="",X.length)je.hidden=!0;else{je.hidden=!1;return}[...X].sort((t,n)=>t.token.localeCompare(n.token)).forEach(t=>{const n=document.createElement("div");n.className="market-card";const o=document.createElement("div");o.className="mk-header";const s=document.createElement("div");s.className="mk-badge";const a=document.createElement("img");a.src=`/api/logo/${t.token}`,a.alt=`${t.token} logo`,a.className="mk-icon",a.onerror=function(){this.style.display="none";const d=document.createElement("span");d.textContent=(t.token||"?").slice(0,3),d.className="mk-icon-text",s.appendChild(d)},s.appendChild(a);const i=document.createElement("div");i.className="mk-title",i.textContent=t.token,o.appendChild(s),o.appendChild(i);const r=document.createElement("div");r.className="mk-price",r.textContent=pt(t.lastPrice);const c=document.createElement("div");c.className="mk-row";const m=typeof t.dayChangePct=="number"?t.dayChangePct:null,g=document.createElement("span");g.className="mk-chip mk-chip-primary "+(m===null?"neutral":m>=0?"chg-pos":"chg-neg");const u=ze==="cmc"?"24h":"EOD";if(g.textContent=`${u} ${ce(m)}`,c.appendChild(g),typeof t.change1hPct=="number"){const d=document.createElement("span");d.className="mk-chip "+(t.change1hPct>=0?"chg-pos":"chg-neg"),d.textContent=`1h ${ce(t.change1hPct)}`,c.appendChild(d)}if(typeof t.change7dPct=="number"){const d=document.createElement("span");d.className="mk-chip "+(t.change7dPct>=0?"chg-pos":"chg-neg"),d.textContent=`7d ${ce(t.change7dPct)}`,c.appendChild(d)}const l=document.createElement("div");if(l.className="mk-row mk-secondary",typeof t.volume24h=="number"){const d=document.createElement("span");d.className="mk-info",d.textContent=`Vol: ${Ke(t.volume24h)}`,l.appendChild(d)}if(typeof t.marketCap=="number"){const d=document.createElement("span");d.className="mk-info",d.textContent=`MCap: ${Ke(t.marketCap)}`,l.appendChild(d)}if(typeof t.change30mPct=="number"){const d=document.createElement("span");d.className="mk-chip "+(t.change30mPct>=0?"chg-pos":"chg-neg"),d.textContent=`30m ${ce(t.change30mPct)}`,c.appendChild(d)}if(t.error){const d=document.createElement("div");d.className="mk-err muted",d.textContent="Data unavailable",n.appendChild(d)}n.appendChild(o),n.appendChild(r),n.appendChild(c),l.children.length>0&&n.appendChild(l),qe.appendChild(n)})}function Ie(){Je(),S(),$e()}window.closeTokenRequestModal=et;window.submitTokenRequest=St;
