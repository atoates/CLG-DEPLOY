import"./config-B88kdatl.js";function N(){const t=typeof window<"u"&&window.BACKEND_URL?window.BACKEND_URL:"";if(t)return t;try{const e=window.location.hostname||"";if(e&&e!=="localhost"&&e!=="127.0.0.1")return"https://app.crypto-lifeguard.com"}catch{}return""}function m(t){return`${N()}${t}`}function u(t,e={}){return fetch(t,{credentials:"include",...e})}const M=document.getElementById("prof-name"),R=document.getElementById("prof-email"),g=document.getElementById("prof-avatar"),I=document.getElementById("prof-username"),S=document.getElementById("prof-username-input"),D=document.getElementById("prof-username-save"),T=document.getElementById("prof-watch-pills"),E=document.getElementById("prof-add-token"),l=document.getElementById("prof-token-input"),C=document.getElementById("prof-show-all"),p=document.getElementById("prof-currency-select"),r=document.getElementById("prof-msg"),w=document.getElementById("avatar-presets");let o=null;const v=new Set(["BTC","ETH","USDC","MATIC","SOL"]);let i=null,c=-1,B=[];function O(){l&&(i=document.createElement("div"),i.className="autocomplete-list",i.style.display="none",l.parentElement.style.position="relative",l.parentElement.appendChild(i))}async function P(){try{const t=await u(m("/api/tokens/search"));t.ok&&(B=await t.json())}catch(t){console.warn("Failed to fetch token database:",t)}}function $(t){if(!t||t.length<1)return[];const e=t.toLowerCase(),n=B.filter(a=>{const s=a.symbol.toLowerCase().includes(e),d=a.name.toLowerCase().includes(e);return s||d});return n.sort((a,s)=>{const d=a.symbol.toLowerCase(),y=s.symbol.toLowerCase(),A=a.name.toLowerCase(),L=s.name.toLowerCase();return d===e||d.startsWith(e)&&!y.startsWith(e)?-1:!d.startsWith(e)&&y.startsWith(e)?1:A.startsWith(e)&&!L.startsWith(e)?-1:!A.startsWith(e)&&L.startsWith(e)?1:a.symbol.localeCompare(s.symbol)}),n.slice(0,10)}function W(t,e){if(!e)return t;const n=new RegExp(`(${e})`,"gi");return t.replace(n,"<strong>$1</strong>")}function H(t,e){if(i){if(!t.length&&!e.trim()){i.style.display="none";return}i.innerHTML="",c=-1,t.forEach((n,a)=>{const s=document.createElement("div");s.className="autocomplete-item",s.dataset.index=a,s.dataset.symbol=n.symbol;const d=`${n.name} | ${n.symbol}`;s.innerHTML=W(d,e),s.addEventListener("click",()=>{k(n.symbol)}),s.addEventListener("mouseenter",()=>{c=a,b()}),i.appendChild(s)}),i.style.display="block"}}function f(){i&&(i.style.display="none",c=-1)}function b(){if(!i)return;i.querySelectorAll(".autocomplete-item").forEach((e,n)=>{n===c?e.classList.add("selected"):e.classList.remove("selected")})}function k(t){const e=t.toUpperCase().trim();if(!e){f(),l.value="";return}o.watchlist=o.watchlist||[],o.watchlist.includes(e)||(o.watchlist.push(e),v.add(e),h(),x()),l.value="",f(),l.focus()}function j(t){g.innerHTML="";const e=t&&t.avatar||"";if(e){const n=document.createElement("img");n.src=e,n.alt="Avatar",n.width=80,n.height=80,n.style.borderRadius="50%",n.style.objectFit="cover",g.appendChild(n)}else{const n=(t&&t.name||"").trim().split(/\s+/).map(s=>s[0]).slice(0,2).join("").toUpperCase()||"U",a=document.createElement("div");a.className="avatar-initials",a.textContent=n,g.appendChild(a)}}function x(){T.innerHTML="",(o.watchlist||[]).forEach(t=>{const e=document.createElement("span");e.className="pill",e.textContent=t;const n=document.createElement("button");n.type="button",n.className="pill-x",n.setAttribute("aria-label",`Remove ${t}`),n.textContent="Ã—",n.addEventListener("click",()=>{o.watchlist=o.watchlist.filter(a=>a!==t),h(),x()}),e.appendChild(n),T.appendChild(e)})}function F(){const t=document.getElementById("token-datalist");t&&(t.innerHTML="",Array.from(v).sort().forEach(e=>{const n=document.createElement("option");n.value=e,t.appendChild(n)}))}async function J(){try{const t=await u(m("/api/alerts"));t.ok&&(await t.json()).forEach(n=>{const a=String(n.token||"").toUpperCase().trim();a&&/^[A-Z0-9]{2,15}$/.test(a)&&v.add(a)})}catch{}o&&Array.isArray(o.watchlist)&&o.watchlist.forEach(t=>v.add(String(t||"").toUpperCase().trim())),F()}async function _(){if(o=await(await u(m("/api/me"))).json(),!o.loggedIn){window.location.href="/";return}M.textContent=o.profile?.name||"Your profile",I.textContent=o.profile?.username?`@${o.profile.username}`:"",R.textContent=o.profile?.email||"",j(o.profile||{}),C.checked=!!o.showAll,p&&o.currency&&(p.value=o.currency),x(),await J(),o.profile?.username&&(S.value=o.profile.username)}function h(){u(m("/api/me/prefs"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({watchlist:o.watchlist||[],severity:o.severity||["critical","warning","info"],showAll:!!o.showAll,dismissed:o.dismissed||[],currency:o.currency||"USD"})}).then(()=>{r.textContent="Preferences saved.",setTimeout(()=>r.textContent="",1500)})}E.addEventListener("click",()=>{const t=(l.value||"").toUpperCase().trim();t&&k(t)});l&&(l.addEventListener("input",t=>{const e=t.target.value.trim();if(e.length>=1){const n=$(e);H(n,e)}else f()}),l.addEventListener("keydown",t=>{if(!i||i.style.display==="none"){t.key==="Enter"&&(t.preventDefault(),E.click());return}const e=i.querySelectorAll(".autocomplete-item");if(t.key==="ArrowDown"){t.preventDefault(),c=Math.min(c+1,e.length-1),b();const n=e[c];n&&n.scrollIntoView({block:"nearest"})}else if(t.key==="ArrowUp"){t.preventDefault(),c=Math.max(c-1,0),b();const n=e[c];n&&n.scrollIntoView({block:"nearest"})}else if(t.key==="Enter")if(t.preventDefault(),c>=0&&c<e.length){const a=e[c].dataset.symbol;a&&k(a)}else l.value.trim()&&E.click();else t.key==="Escape"&&f()}),l.addEventListener("blur",()=>{setTimeout(()=>f(),200)}));C.addEventListener("change",()=>{o.showAll=C.checked,h()});p&&p.addEventListener("change",()=>{o.currency=p.value,h(),r.textContent="Currency preference saved. Reload the page to see changes.",setTimeout(()=>r.textContent="",3e3)});document.getElementById("btn-logout").addEventListener("click",()=>{u(m("/auth/logout"),{method:"POST"}).finally(()=>window.location.href="/")});document.getElementById("btn-export").addEventListener("click",async()=>{const t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),e=document.createElement("a");e.href=URL.createObjectURL(t),e.download="crypto-lifeguard-profile.json",document.body.appendChild(e),e.click(),e.remove()});D.addEventListener("click",async()=>{const t=(S.value||"").trim();if(!t)return;const e=await u(m("/api/me/username"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})});if(!e.ok){const a=await e.json().catch(()=>({}));r.textContent=a.error==="taken"?"That username is taken.":a.rules||"Invalid username.",setTimeout(()=>r.textContent="",2e3);return}const n=await e.json();o.profile=o.profile||{},o.profile.username=n.username,I.textContent=`@${n.username}`,r.textContent="Username saved.",setTimeout(()=>r.textContent="",1500)});const V=["https://api.dicebear.com/9.x/identicon/svg?seed=A","https://api.dicebear.com/9.x/identicon/svg?seed=B","https://api.dicebear.com/9.x/identicon/svg?seed=C","https://api.dicebear.com/9.x/bottts/svg?seed=Robo","https://api.dicebear.com/9.x/fun-emoji/svg?seed=Joy"];function K(){w&&(w.innerHTML="",V.forEach(t=>{const e=document.createElement("button");e.className="pill",e.style.padding="4px 6px";const n=document.createElement("img");n.src=t,n.width=24,n.height=24,n.style.borderRadius="999px",e.appendChild(n),e.addEventListener("click",async()=>{try{const a=await u(m("/api/me/avatar"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!a.ok){const d=await a.json().catch(()=>({}));r.textContent=d.error==="invalid_url"?"Invalid avatar URL.":"Failed to update avatar.",setTimeout(()=>r.textContent="",1800);return}const s=await a.json();o.profile=o.profile||{},o.profile.avatar=s.avatar||t,j(o.profile),r.textContent="Avatar updated.",setTimeout(()=>r.textContent="",1200)}catch{r.textContent="Failed to update avatar.",setTimeout(()=>r.textContent="",1500)}}),w.appendChild(e)}))}K();O();P();_();function U(){const t=document.querySelectorAll(".sev-btn[data-sev]"),e=new Set((o?.severity&&Array.isArray(o.severity)?o.severity:["critical","warning","info"]).map(n=>String(n)));t.forEach(n=>{const a=n.getAttribute("data-sev");e.has(a)?n.classList.add("active"):n.classList.remove("active")})}document.addEventListener("click",t=>{const e=t.target.closest(".sev-btn[data-sev]");if(!e)return;const n=e.getAttribute("data-sev"),a=Array.isArray(o?.severity)?[...o.severity]:["critical","warning","info"],s=a.indexOf(n);s>=0?a.splice(s,1):a.push(n);const d=["critical","warning","info"];o.severity=d.filter(y=>a.includes(y)),U(),h()});setTimeout(()=>U(),0);
