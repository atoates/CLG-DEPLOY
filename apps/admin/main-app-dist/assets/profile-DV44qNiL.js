import"./config-D5DNV0UN.js";function N(){const t=typeof window<"u"&&window.BACKEND_URL?window.BACKEND_URL:"";if(t&&t!=="__BACKEND_URL__")return t;try{const e=window.location.hostname||"";if(e&&e!=="localhost"&&e!=="127.0.0.1")return"https://clg-admin-production.up.railway.app"}catch{}return""}function u(t){return`${N()}${t}`}function m(t,e={}){return fetch(t,{credentials:"include",...e})}const R=document.getElementById("prof-name"),P=document.getElementById("prof-email"),g=document.getElementById("prof-avatar"),S=document.getElementById("prof-username"),I=document.getElementById("prof-username-input"),D=document.getElementById("prof-username-save"),L=document.getElementById("prof-watch-pills"),E=document.getElementById("prof-add-token"),l=document.getElementById("prof-token-input"),C=document.getElementById("prof-show-all"),p=document.getElementById("prof-currency-select"),i=document.getElementById("prof-msg"),w=document.getElementById("avatar-presets");let o=null;const v=new Set(["BTC","ETH","USDC","MATIC","SOL"]);let r=null,c=-1,B=[];function M(){l&&(r=document.createElement("div"),r.className="autocomplete-list",r.style.display="none",l.parentElement.style.position="relative",l.parentElement.appendChild(r))}async function O(){try{const t=await m(u("/api/tokens/search"));t.ok&&(B=await t.json())}catch(t){console.warn("Failed to fetch token database:",t)}}function _(t){if(!t||t.length<1)return[];const e=t.toLowerCase(),n=B.filter(a=>{const s=a.symbol.toLowerCase().includes(e),d=a.name.toLowerCase().includes(e);return s||d});return n.sort((a,s)=>{const d=a.symbol.toLowerCase(),y=s.symbol.toLowerCase(),T=a.name.toLowerCase(),A=s.name.toLowerCase();return d===e||d.startsWith(e)&&!y.startsWith(e)?-1:!d.startsWith(e)&&y.startsWith(e)?1:T.startsWith(e)&&!A.startsWith(e)?-1:!T.startsWith(e)&&A.startsWith(e)?1:a.symbol.localeCompare(s.symbol)}),n.slice(0,10)}function $(t,e){if(!e)return t;const n=new RegExp(`(${e})`,"gi");return t.replace(n,"<strong>$1</strong>")}function W(t,e){if(r){if(!t.length&&!e.trim()){r.style.display="none";return}r.innerHTML="",c=-1,t.forEach((n,a)=>{const s=document.createElement("div");s.className="autocomplete-item",s.dataset.index=a,s.dataset.symbol=n.symbol;const d=`${n.name} | ${n.symbol}`;s.innerHTML=$(d,e),s.addEventListener("click",()=>{k(n.symbol)}),s.addEventListener("mouseenter",()=>{c=a,b()}),r.appendChild(s)}),r.style.display="block"}}function f(){r&&(r.style.display="none",c=-1)}function b(){if(!r)return;r.querySelectorAll(".autocomplete-item").forEach((e,n)=>{n===c?e.classList.add("selected"):e.classList.remove("selected")})}function k(t){const e=t.toUpperCase().trim();if(!e){f(),l.value="";return}o.watchlist=o.watchlist||[],o.watchlist.includes(e)||(o.watchlist.push(e),v.add(e),h(),x()),l.value="",f(),l.focus()}function j(t){g.innerHTML="";const e=t&&t.avatar||"";if(e){const n=document.createElement("img");n.src=e,n.alt="Avatar",n.width=80,n.height=80,n.style.borderRadius="50%",n.style.objectFit="cover",g.appendChild(n)}else{const n=(t&&t.name||"").trim().split(/\s+/).map(s=>s[0]).slice(0,2).join("").toUpperCase()||"U",a=document.createElement("div");a.className="avatar-initials",a.textContent=n,g.appendChild(a)}}function x(){L.innerHTML="",(o.watchlist||[]).forEach(t=>{const e=document.createElement("span");e.className="pill",e.textContent=t;const n=document.createElement("button");n.type="button",n.className="pill-x",n.setAttribute("aria-label",`Remove ${t}`),n.textContent="×",n.addEventListener("click",()=>{o.watchlist=o.watchlist.filter(a=>a!==t),h(),x()}),e.appendChild(n),L.appendChild(e)})}function H(){const t=document.getElementById("token-datalist");t&&(t.innerHTML="",Array.from(v).sort().forEach(e=>{const n=document.createElement("option");n.value=e,t.appendChild(n)}))}async function J(){try{const t=await m(u("/api/alerts"));t.ok&&(await t.json()).forEach(n=>{const a=String(n.token||"").toUpperCase().trim();a&&/^[A-Z0-9]{2,15}$/.test(a)&&v.add(a)})}catch{}o&&Array.isArray(o.watchlist)&&o.watchlist.forEach(t=>v.add(String(t||"").toUpperCase().trim())),H()}async function F(){if(o=await(await m(u("/api/me"))).json(),!o.loggedIn){window.location.href="/";return}R.textContent=o.profile?.name||"Your profile",S.textContent=o.profile?.username?`@${o.profile.username}`:"",P.textContent=o.profile?.email||"",j(o.profile||{}),C.checked=!!o.showAll,p&&o.currency&&(p.value=o.currency),x(),await J(),o.profile?.username&&(I.value=o.profile.username)}function h(){m(u("/api/me/prefs"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({watchlist:o.watchlist||[],severity:o.severity||["critical","warning","info"],showAll:!!o.showAll,dismissed:o.dismissed||[],currency:o.currency||"USD"})}).then(()=>{i.textContent="Preferences saved.",setTimeout(()=>i.textContent="",1500)})}E.addEventListener("click",()=>{const t=(l.value||"").toUpperCase().trim();t&&k(t)});l&&(l.addEventListener("input",t=>{const e=t.target.value.trim();if(e.length>=1){const n=_(e);W(n,e)}else f()}),l.addEventListener("keydown",t=>{if(!r||r.style.display==="none"){t.key==="Enter"&&(t.preventDefault(),E.click());return}const e=r.querySelectorAll(".autocomplete-item");if(t.key==="ArrowDown"){t.preventDefault(),c=Math.min(c+1,e.length-1),b();const n=e[c];n&&n.scrollIntoView({block:"nearest"})}else if(t.key==="ArrowUp"){t.preventDefault(),c=Math.max(c-1,0),b();const n=e[c];n&&n.scrollIntoView({block:"nearest"})}else if(t.key==="Enter")if(t.preventDefault(),c>=0&&c<e.length){const a=e[c].dataset.symbol;a&&k(a)}else l.value.trim()&&E.click();else t.key==="Escape"&&f()}),l.addEventListener("blur",()=>{setTimeout(()=>f(),200)}));C.addEventListener("change",()=>{o.showAll=C.checked,h()});p&&p.addEventListener("change",()=>{o.currency=p.value,h(),i.textContent="Currency preference saved. Reload the page to see changes.",setTimeout(()=>i.textContent="",3e3)});document.getElementById("btn-logout").addEventListener("click",()=>{m(u("/auth/logout"),{method:"POST"}).finally(()=>window.location.href="/")});document.getElementById("btn-export").addEventListener("click",async()=>{const t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),e=document.createElement("a");e.href=URL.createObjectURL(t),e.download="crypto-lifeguard-profile.json",document.body.appendChild(e),e.click(),e.remove()});D.addEventListener("click",async()=>{const t=(I.value||"").trim();if(!t)return;const e=await m(u("/api/me/username"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t})});if(!e.ok){const a=await e.json().catch(()=>({}));i.textContent=a.error==="taken"?"That username is taken.":a.rules||"Invalid username.",setTimeout(()=>i.textContent="",2e3);return}const n=await e.json();o.profile=o.profile||{},o.profile.username=n.username,S.textContent=`@${n.username}`,i.textContent="Username saved.",setTimeout(()=>i.textContent="",1500)});const K=["https://api.dicebear.com/9.x/identicon/svg?seed=A","https://api.dicebear.com/9.x/identicon/svg?seed=B","https://api.dicebear.com/9.x/identicon/svg?seed=C","https://api.dicebear.com/9.x/bottts/svg?seed=Robo","https://api.dicebear.com/9.x/fun-emoji/svg?seed=Joy"];function V(){w&&(w.innerHTML="",K.forEach(t=>{const e=document.createElement("button");e.className="pill",e.style.padding="4px 6px";const n=document.createElement("img");n.src=t,n.width=24,n.height=24,n.style.borderRadius="999px",e.appendChild(n),e.addEventListener("click",async()=>{try{const a=await m(u("/api/me/avatar"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!a.ok){const d=await a.json().catch(()=>({}));i.textContent=d.error==="invalid_url"?"Invalid avatar URL.":"Failed to update avatar.",setTimeout(()=>i.textContent="",1800);return}const s=await a.json();o.profile=o.profile||{},o.profile.avatar=s.avatar||t,j(o.profile),i.textContent="Avatar updated.",setTimeout(()=>i.textContent="",1200)}catch{i.textContent="Failed to update avatar.",setTimeout(()=>i.textContent="",1500)}}),w.appendChild(e)}))}V();M();O();async function q(){const e=new URLSearchParams(window.location.search).get("auth_token");if(e){console.log("Auth token detected, exchanging for session...");try{const n=await m(u("/auth/exchange-token"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),a=await n.json();console.log("Token exchange response:",n.status,a),n.ok?(console.log("✅ Session cookie set successfully"),window.history.replaceState({},document.title,"/profile.html")):console.error("❌ Token exchange failed:",a)}catch(n){console.error("❌ Token exchange error:",n)}}else console.log("No auth token in URL")}q().then(()=>F());function U(){const t=document.querySelectorAll(".sev-btn[data-sev]"),e=new Set((o?.severity&&Array.isArray(o.severity)?o.severity:["critical","warning","info"]).map(n=>String(n)));t.forEach(n=>{const a=n.getAttribute("data-sev");e.has(a)?n.classList.add("active"):n.classList.remove("active")})}document.addEventListener("click",t=>{const e=t.target.closest(".sev-btn[data-sev]");if(!e)return;const n=e.getAttribute("data-sev"),a=Array.isArray(o?.severity)?[...o.severity]:["critical","warning","info"],s=a.indexOf(n);s>=0?a.splice(s,1):a.push(n);const d=["critical","warning","info"];o.severity=d.filter(y=>a.includes(y)),U(),h()});setTimeout(()=>U(),0);
