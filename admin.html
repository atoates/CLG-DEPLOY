<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Alerts Dashboard</title>
  <link rel="stylesheet" href="/styles.css?v=20251003f" />
  <style>
  /* Ensure hidden elements are actually hidden */
  [hidden]{ display:none !important; }
  .admin-grid{ display:grid; grid-template-columns: 320px 1fr; gap:16px; align-items:start; }
    .admin-pane{ background:#fff; border:1px solid rgba(2,6,23,0.06); border-radius:12px; padding:12px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    .admin-list{ max-height: calc(100vh - 280px); overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .admin-item{ padding:10px; border:1px solid rgba(2,6,23,0.08); border-radius:10px; cursor:pointer; background:#f8fafc; display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; }
    .admin-item:hover{ background:#eef6ff; }
  .admin-item.active{ outline: 2px solid var(--ocean-blue); outline-offset: 2px; background:#fff; border-radius:12px; }
    .token-badge{ font-weight:800; background:#e6f3ff; color:#0b4a8f; border:1px solid #cfe8ff; border-radius:999px; padding:4px 8px; }
    .sev-chip{ border-radius:999px; padding:4px 8px; font-weight:700; font-size:12px; border:1px solid transparent; }
    .sev-critical{ background:#ffe8e8; border-color:#ffc6c6; color:#8f1111; }
    .sev-warning{ background:#fff6dd; border-color:#ffe7a3; color:#8a6a00; }
    .sev-info{ background:#e8fff5; border-color:#b9f3d3; color:#0c6a45; }
    .title-line{ font-weight:700; color:#0f172a; }
    .meta-line{ font-size:12px; color:#475569; }
  .field{ display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
    .field label{ font-size:12px; font-weight:800; color:#334155; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .seg{ display:inline-flex; border:1px solid rgba(2,6,23,0.12); border-radius:10px; overflow:hidden; }
    .seg button{ background:#fff; border:0; padding:8px 12px; cursor:pointer; font-weight:700; }
    .seg button.active{ background:#eef6ff; color:#0456b2; }
    .tags-wrap{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag-pill{ display:inline-flex; align-items:center; gap:6px; background:#eef6ff; border:1px solid #d9ecff; color:#0b4a8f; padding:6px 10px; border-radius:20px; font-weight:600; }
    .tag-pill .remove{ background:#dc2626; color:#fff; border:0; border-radius:12px; width:18px; height:18px; cursor:pointer; }
    .tag-add{ min-width:140px; }
    .form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form-grid .field.full{ grid-column: 1 / -1; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,0), #fff 40%); padding-top:8px; }
    .danger{ background:#dc2626; }
    .note{ font-size:12px; color:#475569; }
    .muted{ color:#64748b; font-size:12px; }
    .side-note{ font-size:12px; color:#334155; margin-top:6px; }
    .search{ width:100%; }
  /* Tighter inputs for admin (force single-line except Description) */
  .admin-pane .input{ padding:6px 10px !important; min-height:30px !important; height:30px !important; font-size:14px; border-radius:8px; line-height:1.2; flex: 0 0 auto !important; width: 100%; }
  .admin-pane input.input, .admin-pane input[type="text"].input, .admin-pane input[type="search"].input{ height:30px !important; min-height:30px !important; }
  .admin-pane .search.input{ height:30px !important; min-height:30px !important; }
  .admin-pane input[type="datetime-local"].input{ height:30px !important; min-height:30px !important; }
  .admin-pane textarea.input{ height:120px !important; min-height:120px !important; resize:vertical; line-height:1.35; }
  .admin-pane .seg button{ padding:6px 8px; font-size:13px; }
  /* Avoid floating Save/Delete inside editor */
  .admin-pane .actions{ position:static; background:transparent; padding-top:0; }

    /* Tabs */
    .admin-tabs{ display:flex; gap:8px; margin-bottom:10px; }
    .admin-tab{ background:#eef6ff; border:1px solid #d9ecff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; color:#0456b2; }
    .admin-tab.active{ background:#fff; border-color: var(--ocean-blue); box-shadow:0 0 0 4px var(--ring); color: var(--ocean-blue); }
    .tools-wrap{ max-width: 720px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; }
  .backup-link{ color:#0f172a; text-decoration:none; font-weight:700; display:inline-block; padding:4px 0; }
  .backup-link:hover{ text-decoration:underline; }
    /* User cards */
    .user-card{ padding:12px; border:1px solid rgba(2,6,23,0.08); border-radius:10px; background:#f8fafc; display:grid; grid-template-columns:48px 1fr auto; gap:12px; align-items:center; margin-bottom:8px; }
    .user-card:hover{ background:#eef6ff; }
    .user-avatar{ width:48px; height:48px; border-radius:50%; background:#e0e7ff; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:700; color:#4f46e5; overflow:hidden; }
    .user-avatar img{ width:100%; height:100%; object-fit:cover; }
    .user-info{ display:flex; flex-direction:column; gap:4px; }
    .user-name{ font-weight:700; color:#0f172a; }
    .user-email{ font-size:12px; color:#64748b; }
    .user-meta{ display:flex; gap:8px; flex-wrap:wrap; font-size:11px; color:#94a3b8; }
    .user-badge{ background:#e0e7ff; color:#4f46e5; padding:2px 6px; border-radius:4px; font-weight:600; }
    .user-badge.google{ background:#e8f5e9; color:#2e7d32; }
    .user-stats{ display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
    .user-stat{ font-size:12px; color:#475569; }
    .user-stat strong{ color:#0f172a; font-weight:700; }
    @media (max-width: 1100px){ .admin-grid{ grid-template-columns: 1fr; } .admin-list{ max-height:none; } }
  </style>
  
</head>
<body>
  <header class="topbar"><div class="topbar-inner">
    <a class="brand-wrap" href="/" style="text-decoration:none; color:inherit;">
      <img class="brand-logo" src="/logo.webp" alt="Logo" />
      <div class="brand-text"><h1 class="brand-title">Crypto Lifeguard</h1><p class="brand-tagline">Admin dashboard</p></div>
    </a>
    <div class="actions">
      <div class="dropdown">
        <button id="user-menu-btn" class="menu-btn" aria-haspopup="true" aria-expanded="false">
          Account ▾
        </button>
        <div id="user-menu" class="menu" hidden>
          <a class="menu-item" href="/">Home</a>
          <hr />
          <button class="menu-item" data-action="settings">Settings</button>
          <button class="menu-item" data-action="help">Help</button>
          <hr />
          <button class="menu-item" data-action="logout" id="menu-logout" hidden>Log out</button>
        </div>
      </div>
    </div>
  </div></header>

  <main class="container">
    <section class="card">
      <div id="admin-info" class="note" style="margin-bottom:10px"></div>
      <h2 class="section-title">Alerts</h2>
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="alerts">Alerts</button>
        <button class="admin-tab" data-tab="users">Users</button>
        <button class="admin-tab" data-tab="tools">Tools</button>
        <button class="admin-tab" data-tab="upload">Upload</button>
      </div>

      <div id="alerts-pane" class="admin-grid">
        <!-- Left: searchable list -->
        <aside class="admin-pane">
          <div class="row" style="justify-content:space-between; margin-bottom:8px">
            <button id="btn-new" class="btn">+ New alert</button>
          </div>
          <div class="field">
            <label>Search</label>
            <input id="search-input" class="input search" placeholder="Filter by token, title, or severity…" />
          </div>
          <div id="list" class="admin-list"></div>
        </aside>

        <!-- Middle: editor -->
        <section class="admin-pane">
          <form id="editor">
            <div class="form-grid">
              <div class="field">
                <label>Token</label>
                <input id="f-token" class="input" placeholder="e.g. ETH" />
              </div>
              <div class="field">
                <label>Severity</label>
                <div class="seg" id="sev-seg">
                  <button type="button" data-sev="critical">Critical</button>
                  <button type="button" data-sev="warning">Warning</button>
                  <button type="button" data-sev="info">Info</button>
                </div>
              </div>
              <div class="field full">
                <label>Title</label>
                <input id="f-title" class="input" />
              </div>
              <div class="field full">
                <label>Description</label>
                <textarea id="f-desc" class="input" rows="5"></textarea>
              </div>
              <div class="field full">
                <label>Further information</label>
                <textarea id="f-info" class="input" rows="4" placeholder="Optional extended details"></textarea>
              </div>
              <div class="field">
                <label>Deadline</label>
                <input id="f-deadline-local" class="input" type="datetime-local" />
                <div class="muted">Saves as ISO (UTC) automatically.</div>
              </div>
              <div class="field">
                <label>Source</label>
                <div class="row">
                  <select id="f-source-type" class="input" style="height:32px" title="Pick the source type">
                    <option value="">— Select type —</option>
                    <option value="anonymous">🙈 Anonymous</option>
                    <option value="mainstream-media">📰 Mainstream media</option>
                    <option value="trusted-source">✅ Trusted source</option>
                    <option value="social-media">💬 Social media</option>
                    <option value="dev-team">🛠️ Dev. Team</option>
                  </select>
                  <input id="f-source-url" class="input" placeholder="https://… (optional)" />
                </div>
                <div class="muted" style="margin-top:4px; display:flex; gap:10px; flex-wrap:wrap;">
                  <span title="Unverified tip or rumor">🙈 Anonymous</span>
                  <span title="Established outlet (e.g., Reuters, Bloomberg)">📰 Mainstream</span>
                  <span title="Trusted industry researcher or analyst">✅ Trusted</span>
                  <span title="X/Twitter, Reddit, Telegram">💬 Social</span>
                  <span title="Official team or foundation communication">🛠️ Dev. Team</span>
                </div>
              </div>
              <div class="field full">
                <label>Tags</label>
                <!-- Admin tag selector mirrors main dropdown UX -->
                <div class="tag-dropdown-container">
                  <div class="custom-dropdown">
                    <button type="button" class="dropdown-trigger" id="admin-tag-dropdown-trigger">
                      <span class="dropdown-text" id="admin-tag-dropdown-text">Select tags...</span>
                      <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-options" id="admin-tag-dropdown-options"></div>
                  </div>
                </div>
                <div id="admin-selected-tags" class="selected-tags-pills"></div>
                <!-- Hidden legacy pills container for backward compatibility (not displayed) -->
                <div class="tags-wrap" id="tags-pills" style="display:none"></div>
              </div>
            </div>
            <div class="actions">
              <button id="btn-delete" class="btn danger" type="button">Delete</button>
              <button id="btn-save" class="btn" type="submit">Save</button>
            </div>
            <p id="msg" class="note"></p>
          </form>
        </section>

      </div>

      <!-- Users tab content -->
      <section id="users-pane" class="admin-pane" hidden>
        <div class="tools-wrap">
          <div class="field">
            <label>Registered Users</label>
            <div class="row" style="margin-bottom:8px; justify-content:space-between">
              <div id="users-stats" class="note"></div>
              <button id="btn-refresh-users" class="btn" type="button">Refresh</button>
            </div>
            <div class="field">
              <input id="users-search-input" class="input search" placeholder="Search by name, email, or username…" />
            </div>
            <div id="users-list" class="admin-list" style="max-height:calc(100vh - 360px)"></div>
          </div>
        </div>
      </section>

      <!-- Tools tab content -->
      <section id="tools-pane" class="admin-pane" hidden>
        <div class="tools-wrap">
          <div class="field">
            <label>Admin token</label>
            <div class="row">
              <input id="admin-token-input" class="input" placeholder="ADMIN_TOKEN" />
              <button id="btn-save-token" class="btn" type="button">Use</button>
            </div>
            <div class="side-note" id="token-status">No token</div>
            <div class="muted">The Admin token is a shared secret set via the ADMIN_TOKEN environment variable. It authorizes protected admin actions (like backups and direct alert writes). If your Google account email is on the admin allow-list, you won’t need a token. When you paste a token here, it’s stored in your browser’s localStorage and sent as a Bearer header for admin routes. Remove it anytime by clearing the field and clicking Use.</div>
          </div>
          <hr />
          <div class="field">
            <label>Backups</label>
            <div class="row" style="margin-bottom:8px">
              <button id="btn-backup-now" class="btn" type="button">Backup now</button>
              <button id="btn-refresh-backups" class="btn" type="button">Refresh</button>
            </div>
            <div id="backup-list" class="admin-list" style="max-height:260px"></div>
          </div>

        </div>
      </section>

      <!-- Upload tab content -->
      <section id="upload-pane" class="admin-pane" hidden>
        <div class="tools-wrap">
          <div class="field">
            <label>Bulk Import Alerts</label>
            <div class="csv-upload-container">
              <div class="upload-area" id="csv-upload-area">
                <input type="file" id="csv-file-input" accept=".csv" hidden />
                <div class="upload-content">
                  <div class="upload-icon">📂</div>
                  <p class="upload-text">
                    <strong>Click to upload</strong> or drag and drop your CSV file here
                  </p>
                  <p class="upload-hint">
                    Supported format: CSV with columns: token, title, description, severity, deadline, tags, further_info, source_type, source_url
                  </p>
                </div>
              </div>
              <div class="csv-actions">
                <button id="csv-template-btn" class="btn" type="button">📥 Download CSV Template</button>
                <button id="csv-import-btn" class="btn" type="button" disabled>⬆️ Import Alerts</button>
              </div>
              <div id="csv-preview-section" class="csv-preview" hidden>
                <h4>Preview (first 5 rows):</h4>
                <div class="csv-table-container">
                  <table id="csv-preview-table" class="csv-preview-table"></table>
                </div>
              </div>
              <div id="csv-status" class="csv-status" hidden></div>
            </div>
            <div class="muted">Upload a CSV file to bulk import multiple alerts at once. Download the template to see the required format. This functionality requires admin authentication.</div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="footer muted"><span>© 2025 Crypto Lifeguard — demo build</span></footer>
  <script>
  // Minimal fallback: tabs toggle, in case module script fails
  document.addEventListener('DOMContentLoaded', function(){
    const tabs = document.querySelectorAll('.admin-tab');
    const alertsPane = document.getElementById('alerts-pane');
    const usersPane = document.getElementById('users-pane');
    const toolsPane = document.getElementById('tools-pane');
    const uploadPane = document.getElementById('upload-pane');
    if (!tabs.length || !alertsPane || !usersPane || !toolsPane || !uploadPane) return;
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const activeTab = t.getAttribute('data-tab');
      alertsPane.hidden = activeTab !== 'alerts';
      usersPane.hidden = activeTab !== 'users';
      toolsPane.hidden = activeTab !== 'tools';
      uploadPane.hidden = activeTab !== 'upload';
    }));
  });
  </script>
  <!-- Load shared tag taxonomy, then admin logic -->
  <script type="module" src="/alerts-tags.js?v=20251003f"></script>
  <script type="module" src="/admin.js?v=20251003f"></script>
</body>
</html>
